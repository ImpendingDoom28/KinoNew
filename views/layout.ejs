<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://bootswatch.com/4/lux/bootstrap.min.css">
    <style type="text/css">
        .container {
            margin-right: 0;
        }
    </style>
    <script>
        let isGetGenres = false;
        let isGetMovies = false;

        function hide(obj) {
            obj.style.display = "none";
        }

        function addNewRowGenres() {
            let li = document.createElement('li');
            let input = document.createElement('input');
            input.name = 'favGenres';
            input.className = 'input-line full-width';
            input.placeholder="Начните вводить жанр...";
            input.setAttribute('list', 'favGenreDatalist');
            input.onchange = addNewRowGenres;
            li.appendChild(input);
            let parent = document.getElementById('favGenresList');
            parent.appendChild(li);
        }
        function addNewRowActors() {
            let li = document.createElement('li');
            let input = document.createElement('input');
            input.name = 'favActors';
            input.className = 'input-line full-width';
            input.placeholder="Начните вводить актёра...";
            input.setAttribute('list', 'favActorsDatalist');
            input.onchange = addNewRowActors;
            input.oninput = function(){searchActors(input.value);};
            li.appendChild(input);
            let parent = document.getElementById('favActorsList');
            parent.appendChild(li);
        }

        function getGenres() {
            const xhr = new XMLHttpRequest();
            const query = 'https://api.themoviedb.org/3/genre/movie/list?language=ru-RU&api_key=f1bb885a34819055db8514823f6050a4';
            xhr.open('GET', query, true);
            let datalist = document.getElementById('favGenreDatalist');
            xhr.onload = function () {
                if(!isGetGenres) {
                    const genres = JSON.parse(this.responseText);
                    genres.genres.forEach((item) => {
                        datalist.innerHTML += '<option id=\"' + item.id + '\">' + item.name + '</option>';
                    });
                    isGetGenres = true;
                }
            };
            xhr.onerror = function () {
                console.log('Ошибка ' + this.status);
            };
            xhr.send();
            console.log('Жанры получены');
        }

        function searchActors(name) {
            let datalist = document.getElementById('favActorsDatalist');
            datalist.innerHTML = '';
            const xhr = new XMLHttpRequest();
            const query = 'https://api.themoviedb.org/3/search/person?api_key=f1bb885a34819055db8514823f6050a4&language=ru-RU&page=1&include_adult=false&query=' + name;
            xhr.open('GET', query, true);
            xhr.onload = function () {
                console.log(this.responseText);
                const results = JSON.parse(this.responseText).results;
                console.log(results);
                results.forEach((item) => {
                    datalist.innerHTML += '<option id=\"' + item.id + '\" value=\"' + item.name + '\" label=\"' + name + '\">';
                });
            };
            xhr.onerror = function () {
                console.log('Ошибка ' + this.status);
            };
            xhr.send();
        }

        function findMovies() {
            const slider = document.getElementById('newMovies');
            //TODO Вероника, если что, сюда вставляй
            let HTMLContent = '';
            const xhr = new XMLHttpRequest();
            const query = 'https://api.themoviedb.org/3/discover/movie?api_key=f1bb885a34819055db8514823f6050a4&language=ru-RU&region=RU&sort_by=release_date.asc&include_adult=false&include_video=false&page=1&primary_release_year=2019';
            xhr.open('GET', query, true);
            xhr.onload = function () {
                if(!isGetMovies) {
                    const results = JSON.parse(this.responseText).results;
                    results.forEach((item) => {
                        HTMLContent += '<div class="slide"><div class="slide-cursor"><a href="https://www.themoviedb.org/movie/' + item.id + '?language=ru-RU"><img src="https://image.tmdb.org/t/p/w600_and_h900_bestv2' + item.poster_path + '" alt="' + item.title + '"><div class="slide-layer_top slide-layer_scale"><div class="slide-text">' + item.title + '</div></div></a></div></div>';
                    });
                    HTMLContent += '</div></div>';
                    console.table(HTMLContent);
                    console.log(HTMLContent);
                    slider.innerHTML = HTMLContent;
                    isGetMovies = true;
                }
            };
            xhr.onerror = function () {
                console.log('Ошибка ' + this.status);
            };
            xhr.send();
        }

        function findMoviesByRecommendations(genres, genresIDs) {
            const slider = document.getElementById('recommendationsByGenre');
            const xhr = new XMLHttpRequest();
            let query = 'https://api.themoviedb.org/3/discover/movie?api_key=f1bb885a34819055db8514823f6050a4&language=ru-RU&region=RU&sort_by=primary_release_date.asc&include_adult=false&include_video=false&page=' + genresIDs.length +
                '&primary_release_year=2019&with_genres=';
            genresIDs.forEach((genreID) => {
                query.concat(genreID + '|');
            });
            xhr.open('GET', query, true);
            xhr.onreadystatechange = function () {
                const results = JSON.parse(this.responseText).results;
                console.log('Нашли мувисы по жанрам успешно!');
                results.forEach((movie) => {
                    genresIDs.forEach((genreID, index) => {
                        if (withGenre(movie, genreID)) {
                            slider.innerHTML += '<h1 class="slider-title">' + genres[index].toUpperCase() + '</h1>';
                            slider.innerHTML += '<div class="slider">';
                            slider.innerHTML += '<div class="slide-cursor">';
                            slider.innerHTML += '<a href="https://www.themoviedb.org/movie' + movie.id + '?language=ru-RU>';
                            slider.innerHTML += '<img src="https://image.tmdb.org/t/p/w600_and_h900_bestv2' + movie.poster_path + '" alt="">';
                            slider.innerHTML += '<div class="slide-layer_top slide-layer_scale">';
                            slider.innerHTML += '<div class="slide-text">' + movie.title + '</div>';
                            slider.innerHTML += '</div></a></div></div>'
                        }
                    })
                });
            }
            xhr.onerror = function () {
                console.log('Ошибка: ' + this.status);
            }
            xhr.send();
        }

        function withGenre(movie, genreID) {
            let help = false;
            movie.genre_ids.forEach((id) => {
                if (id === genreID) {
                    help = true;
                }
            });
            return help;
        }
    </script>
    <title>KinoNew</title>
</head>
<body onload="findMovies()" >
<div class="container">
    <%- body %>
</div>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous">
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous">
</script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous">
</script>
</body>
</html>